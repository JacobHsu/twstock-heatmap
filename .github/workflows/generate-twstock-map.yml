name: Generate Taiwan Stock Heatmap

on:
  # Scheduled run: Taiwan market opens at 9:00 AM (UTC+8)
  # Run at 9:15 AM Taiwan time = 1:15 AM UTC (15 mins after open)
  schedule:
    - cron: '15 1 * * 1-5'  # Weekdays at 1:15 AM UTC (9:15 AM Taiwan)
  
  # Manual trigger
  workflow_dispatch:
    inputs:
      skip_capture:
        description: 'Skip screenshot capture (use existing twstock.png)'
        required: false
        default: 'false'
        type: boolean

env:
  PYTHON_VERSION: '3.11'

permissions:
  contents: write  # ÂÖÅË®±Êèê‰∫§ÂíåÊé®ÈÄÅ
  models: read     # ÂÖÅË®±Ë®™Âïè GitHub Models API

jobs:
  generate-heatmap:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install playwright Pillow requests beautifulsoup4
          playwright install chromium
          playwright install-deps chromium
      
      - name: Scrape HiStock Top Losers
        run: |
          echo "üìâ Scraping histock.tw top losers..."
          python skills/twstock-heatmap/scripts/scrape_histock.py

      - name: Capture Taiwan Stock Heatmaps
        if: ${{ github.event.inputs.skip_capture != 'true' }}
        run: |
          echo "üìä Capturing heatmaps based on top losers industries..."
          echo "Output directory: heatmaps/"
          echo ""

          # Dynamically captures only industries from histock_top_losers.json
          python skills/twstock-heatmap/scripts/capture_twstock.py

          # Verify screenshots in heatmaps directory
          echo ""
          echo "Verifying captured heatmaps:"
          ls -lh heatmaps/*.png

      - name: Analyze Heatmaps with AI
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ü§ñ Analyzing heatmaps with GitHub Models API..."
          echo "Using auto-scan mode with automatic 10s delay between API calls"
          echo ""
          
          # Use --auto mode to automatically scan all heatmaps
          # The script will automatically add 10s delays between API calls to avoid rate limits
          python skills/twstock-heatmap/scripts/analyze_twstock.py --auto
          
          # Verify JSON was created
          if [ -f "api/twstock_top_losers.json" ]; then
            echo ""
            echo "‚úÖ Analysis complete"
            echo "üìÑ API Response Preview:"
            head -n 30 api/twstock_top_losers.json
          else
            echo "‚ùå Analysis failed"
            exit 1
          fi
      
      - name: Generate HTML viewer
        run: |
          # Create simple HTML viewer for the main heatmap
          cat > twstock_index.html << 'EOF'
          <!DOCTYPE html>
          <html lang="zh-TW">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>Taiwan Stock Market Heatmap</title>
              <style>
                  * { margin: 0; padding: 0; box-sizing: border-box; }
                  body {
                      background-color: #1a1a2e;
                      display: flex;
                      flex-direction: column;
                      align-items: center;
                      min-height: 100vh;
                      padding: 20px;
                      font-family: 'Noto Sans TC', sans-serif;
                  }
                  h1 { color: #fff; margin-bottom: 20px; }
                  .timestamp { color: #888; margin-bottom: 20px; }
                  .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; width: 100%; max-width: 1200px; }
                  .card { background: rgba(255,255,255,0.05); padding: 10px; border-radius: 8px; }
                  h2 { color: #4ecdc4; margin-bottom: 10px; font-size: 1.2em; text-align: center; }
                  img {
                      width: 100%;
                      height: auto;
                      border-radius: 4px;
                  }
                  .source { color: #666; margin-top: 20px; }
                  a { color: #4ecdc4; }
              </style>
          </head>
          <body>
              <h1>Taiwan Stock Market Heatmaps</h1>
              <p class="timestamp">Updated: <span id="time"></span></p>
              
              <div class="grid">
                  <div class="card">
                      <h2>TSE Overview (‰∏äÂ∏ÇÁ∏ΩË¶Ω)</h2>
                      <img src="twstock.png" alt="TSE Overview">
                  </div>
                  <div class="card">
                      <h2>OTC Overview (‰∏äÊ´ÉÁ∏ΩË¶Ω)</h2>
                      <img src="twstock_otc.png" alt="OTC Overview">
                  </div>
                  <div class="card">
                      <h2>OTC Electronic (Ê´ÉË≤∑ÈõªÂ≠ê)</h2>
                      <img src="twstock_otc-elec.png" alt="OTC Electronic">
                  </div>
                  <div class="card">
                      <h2>OTC Semi (Ê´ÉË≤∑ÂçäÂ∞éÈ´î)</h2>
                      <img src="twstock_otc-semi.png" alt="OTC Semi">
                  </div>
                  <div class="card">
                      <h2>OTC Construction (Ê´ÉË≤∑ÁáüÂª∫)</h2>
                      <img src="twstock_otc-construction.png" alt="OTC Construction">
                  </div>
                  <div class="card">
                      <h2>TSE Green Energy (‰∏äÂ∏ÇÁ∂†ËÉΩÁí∞‰øù)</h2>
                      <img src="twstock_tse-green.png" alt="TSE Green Energy">
                  </div>
                  <div class="card">
                      <h2>OTC Tourism (‰∏äÊ´ÉËßÄÂÖâ)</h2>
                      <img src="twstock_otc-tourism.png" alt="OTC Tourism">
                  </div>
                  <div class="card">
                      <h2>OTC Green Energy (‰∏äÊ´ÉÁ∂†ËÉΩÁí∞‰øù)</h2>
                      <img src="twstock_otc-green.png" alt="OTC Green Energy">
                  </div>
              </div>

              <p class="source">Data: <a href="https://www.nstock.tw">nStock.tw</a></p>
              <script>document.getElementById('time').textContent = new Date().toLocaleString('zh-TW');</script>
          </body>
          </html>
          EOF
          echo "‚úÖ HTML viewer created"
      
      - name: Commit and push changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # Add all generated files (heatmaps are now in heatmaps/ directory)
          git add heatmaps/*.png twstock_index.html api/twstock_top_losers.json api/histock_top_losers.json
          
          # Check if there are changes to commit
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Update Taiwan stock heatmaps $(date -u '+%Y-%m-%d %H:%M UTC')"
            git push
            echo "‚úÖ Changes committed and pushed"
          fi
      
      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./
          publish_branch: gh-pages
          exclude_assets: '.github,skills/**/*.py,README.md'
      
      - name: Summary
        run: |
          echo "## üìä Taiwan Stock Heatmap Update Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Generated Files:" >> $GITHUB_STEP_SUMMARY
          echo "- \`twstock.png\` - TSE Overview Heatmap" >> $GITHUB_STEP_SUMMARY
          echo "- \`twstock_otc.png\` - OTC Overview Heatmap" >> $GITHUB_STEP_SUMMARY
          echo "- \`twstock_otc-elec.png\` - OTC Electronic Heatmap" >> $GITHUB_STEP_SUMMARY
          echo "- \`twstock_otc-semi.png\` - OTC Semiconductor Heatmap" >> $GITHUB_STEP_SUMMARY
          echo "- \`twstock_otc-construction.png\` - OTC Construction Heatmap" >> $GITHUB_STEP_SUMMARY
          echo "- \`twstock_tse-green.png\` - TSE Green Energy Heatmap" >> $GITHUB_STEP_SUMMARY
          echo "- \`twstock_otc-tourism.png\` - OTC Tourism Heatmap" >> $GITHUB_STEP_SUMMARY
          echo "- \`twstock_otc-green.png\` - OTC Green Energy Heatmap" >> $GITHUB_STEP_SUMMARY
          echo "- \`api/twstock_top_losers.json\` - API data" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ‚úÖ Workflow Complete" >> $GITHUB_STEP_SUMMARY
          echo "All heatmaps captured and analyzed successfully." >> $GITHUB_STEP_SUMMARY
